import{r,j as n}from"./app-Dz0Rbp0h.js";import{T as L}from"./treetable.esm-D6Oa9sBL.js";import{C as S}from"./column.esm-BqjfhWTS.js";import{B as P}from"./button.esm-Diq6oNXP.js";import{u as M}from"./formik.esm-Cy4lwaOU.js";import"./ripple.esm-CYZs3McG.js";import"./index.esm-HViXaaiK.js";import"./paginator.esm-2p2CsUBO.js";import"./inputnumber.esm-C406o3lj.js";import"./inputtext.esm-D_WE3Z_v.js";import"./tooltip.esm-DY0YRRBX.js";import"./index.esm-Be_7JE-C.js";import"./dropdown.esm-CovDHvo0.js";import"./index.esm-D9qUPuzA.js";import"./index.esm-TiU1zUHP.js";import"./overlayservice.esm-DnTU8eSE.js";import"./csstransition.esm-DJl7jKS0.js";import"./index.esm-C0q9DBoq.js";import"./index.esm-BzMgZE_T.js";import"./index.esm-Bni9AK0c.js";import"./index.esm-iV2WGbbz.js";import"./cloneDeep-DJN0yfLA.js";const ne=({csrf_token:h,order:i,productCodesModal:j,setFooter:x,onHide:k,toast:d,setRecords:T})=>{r.useEffect(()=>{console.log("mounted")},[]);const[_,v]=r.useState([]),[y,p]=r.useState(!1),[b,w]=r.useState([]),[O,R]=r.useState([]),[l,f]=r.useState([]),[E,g]=r.useState([]);r.useState([]);let{values:A,setFieldValue:K,handleSubmit:z}=M({initialValues:{postData:[]},onSubmit:t=>{let e=JSON.stringify({codes:t.postData.join(","),_method:"PUT"});fetch(route("super.orders.updateProductCodes",i==null?void 0:i.id),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":h},body:e}).then(s=>s.json()).then(s=>{s.status?(T(s.records),d.current.show({severity:"success",summary:"Başarılı",detail:s.message}),k()):d.current.show({severity:"error",summary:"Hata",detail:s.message})}).catch(s=>{console.log(s),d.current.show({severity:"error",summary:"Hata",detail:"CSRF Token Hatası Lütfen Sayfayı Yenileyiniz.."})}).finally(()=>{p(!1)})}});const D=()=>{p(!0),fetch(route("super.orders.listProductCodes",i==null?void 0:i.id),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":h}}).then(t=>t.json()).then(t=>{t.status?(v(t.codes),w(t.availableCodes)):d.current.show({severity:"error",summary:"Hata",detail:t.message})}).catch(t=>{console.log(t),d.current.show({severity:"error",summary:"Hata",detail:"Ürünler getirilirken bir hata oluştu."})}).finally(()=>{p(!1)})};r.useEffect(()=>{D()},[i]),r.useEffect(()=>{R(()=>(g([]),Object.entries(b).map(([t,e])=>{var s,u;return g(a=>{var m;let o={};return o.codes=e.codes.map(c=>"code_"+c.code),o.product_id=e.id,o.maksimum=(m=i.products.find(c=>c.product_id===e.id))==null?void 0:m.quantity,[...a,o]}),{key:"product_"+t,data:{...e,name:"#"+e.id+" "+e.name+" ("+((s=i.products.find(a=>a.product_id===e.id))==null?void 0:s.quantity)+" Adet) ",maxSelect:(u=i.products.find(a=>a.product_id===e.id))==null?void 0:u.quantity},selectable:!1,children:e.codes.map(a=>(f(o=>({...o,["code_"+a.code]:{checked:i.id===a.order_id,partialChecked:!1}})),{key:"code_"+a.code,data:{name:"Ürün Kodu:  "+a.code,sku:"",...a},selected:!0}))}})))},[_,b]);const F=t=>{let e=t.value,s=Object.keys(l).filter(a=>String(a).includes("product_")?!1:!Object.keys(e).includes(a)||e[a].checked!==l[a].checked||e[a].partialChecked!==l[a].partialChecked),u=s[0];s=e[s[0]],s!==void 0&&s.checked&&E.map(o=>{if(o.codes.includes(u)){let m=Object.keys(l).filter(c=>{if(o.codes.includes(c))return l[c].checked}).length+1;return o.maksimum<m?(d.current.show({severity:"error",summary:"Hata",detail:"Bu ürüne başka ürün kodu tanımlayamazsınız,stok adedi artırabilirsiniz."}),"notupdate"):"update"}}).includes("notupdate")||f(e)},C=r.useRef();return r.useEffect(()=>{const t=()=>{C.current.click()};x(n.jsxs(n.Fragment,{children:[n.jsx(P,{label:"Vazgeç",icon:"pi pi-times",size:"small",link:!0,onClick:k,loading:y}),n.jsx(P,{label:"Kaydet",icon:"pi pi-save",size:"small",className:"p-button-success",loading:y,onClick:t})]}))},[j]),r.useEffect(()=>{K("postData",Object.entries(l).map(([t,e])=>t.includes("code_")&&e.checked?t.replace("code_",""):!1).filter(Boolean))},[l]),n.jsxs("form",{onSubmit:z,children:[n.jsxs(L,{value:O,paginator:!0,showGridlines:!0,rows:5,rowsPerPageOptions:[5,10,25],emptyMessage:"Ürün kodu bulunamadı.",filterMode:"lenient",paginatorTemplate:"RowsPerPageDropdown FirstPageLink PrevPageLink CurrentPageReport NextPageLink LastPageLink",currentPageReportTemplate:"{first}. ile {last}. arası toplam {totalRecords} kayıttan",selectionMode:"checkbox",selectionKeys:l,onSelectionChange:F,tableStyle:{minWidth:"50rem"},children:[n.jsx(S,{field:"name",header:"Ürün Adı",filter:!0,expander:!0,filterMatchMode:"contains",filterPlaceholder:"Ürün Adı | Ürün Kodunda Arama Yapın"}),n.jsx(S,{field:"sku",header:"Ürün Stok Kodu",filter:!0,filterMatchMode:"contains",filterPlaceholder:"Ürün Stok Kodlarında Arama Yapın"})]}),n.jsx("button",{type:"submit",ref:C,className:"hidden"})]})};export{ne as default};
